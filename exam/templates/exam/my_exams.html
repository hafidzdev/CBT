<!-- exam/templates/exam/exam_access.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}Exam Access - CBT System{% endblock %}

{% block page_title %}Exam Access Portal{% endblock %}

{% block extra_head %}
<style>
    .exam-card {
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
    }
    .exam-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    .token-display {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .token-refresh {
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    .time-remaining {
        font-family: 'Courier New', monospace;
        font-weight: bold;
    }
    .token-input {
        letter-spacing: 0.2em;
        font-weight: bold;
        font-family: 'Courier New', monospace;
    }
    .countdown-timer {
        background: linear-gradient(45deg, #667eea, #764ba2);
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-8">
    <!-- Header Section -->
    <div class="token-display rounded-2xl shadow-xl p-8 text-white">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
            <div class="mb-6 md:mb-0">
                <h1 class="text-3xl font-bold mb-2">Exam Access Portal</h1>
                <p class="text-blue-100 text-lg">Access your exams using tokens provided by administrator</p>
                <div class="flex items-center mt-4 space-x-4">
                    <div class="flex items-center">
                        <i class="fas fa-user-graduate mr-2"></i>
                        <span>{{ user.get_full_name|default:user.username }}</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-clock mr-2"></i>
                        <span id="current-time">{{ current_time|date:"F d, Y H:i:s" }}</span>
                    </div>
                </div>
            </div>
            <div class="text-center bg-white bg-opacity-20 rounded-2xl p-6 backdrop-blur-sm">
                <div class="text-4xl font-bold mb-2" id="active-tokens-count">{{ active_tokens.count }}</div>
                <div class="text-lg">Active Tokens</div>
            </div>
        </div>
    </div>

    <!-- Token Access Section -->
    <div class="bg-white rounded-2xl shadow-lg p-6">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                <i class="fas fa-key text-purple-500 mr-3"></i>
                Available Exam Tokens
            </h2>
            <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-semibold">
                {{ active_tokens.count }} Active
            </span>
        </div>

        {% if active_tokens %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for token in active_tokens %}
            <div class="exam-card bg-gradient-to-br from-purple-50 to-blue-50 border border-purple-200 rounded-xl p-6 hover:shadow-lg">
                <!-- Token Header -->
                <div class="flex justify-between items-start mb-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-12 h-12 bg-purple-500 rounded-lg flex items-center justify-center">
                            <i class="fas fa-key text-white"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">{{ token.exam.title }}</h3>
                            <p class="text-sm text-gray-600">{{ token.exam.subject.name|default:"General" }}</p>
                        </div>
                    </div>
                    <span class="bg-green-500 text-white px-3 py-1 rounded-full text-sm font-semibold token-refresh">
                        Active
                    </span>
                </div>

                <!-- Token Display -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Access Token</label>
                    <div class="flex items-center space-x-2">
                        <div class="flex-1 bg-white border border-purple-300 rounded-lg p-3">
                            <code class="text-2xl font-bold text-purple-600 tracking-wider">{{ token.token }}</code>
                        </div>
                        <button onclick="copyToClipboard('{{ token.token }}')" 
                                class="bg-purple-600 text-white p-3 rounded-lg hover:bg-purple-700 transition duration-200">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>

                <!-- Exam Information -->
                <div class="grid grid-cols-2 gap-3 mb-4 text-sm">
                    <div class="text-center bg-white rounded-lg p-2">
                        <p class="text-gray-600">Duration</p>
                        <p class="font-semibold text-gray-800">{{ token.exam.duration_minutes }} min</p>
                    </div>
                    <div class="text-center bg-white rounded-lg p-2">
                        <p class="text-gray-600">Questions</p>
                        <p class="font-semibold text-gray-800">{{ token.exam.questions.count }}</p>
                    </div>
                    <div class="text-center bg-white rounded-lg p-2">
                        <p class="text-gray-600">Passing Score</p>
                        <p class="font-semibold text-green-600">{{ token.exam.passing_score }}%</p>
                    </div>
                    <div class="text-center bg-white rounded-lg p-2">
                        <p class="text-gray-600">Used</p>
                        <p class="font-semibold text-blue-600">{{ token.used_count }}/{{ token.max_usage }}</p>
                    </div>
                </div>

                <!-- Countdown Timer -->
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-yellow-700">Token expires in:</span>
                        <span id="countdown-{{ token.id }}" class="time-remaining text-yellow-800 font-bold">
                            {{ token.time_remaining }}
                        </span>
                    </div>
                    <div class="w-full bg-yellow-200 rounded-full h-2 mt-2">
                        <div id="progress-{{ token.id }}" class="bg-yellow-500 h-2 rounded-full" 
                             style="width: {{ token.percentage_remaining }}%"></div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex space-x-2">
                    <button onclick="startExamWithToken('{{ token.token }}')" 
                            class="flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition duration-200 font-semibold flex items-center justify-center space-x-2">
                        <i class="fas fa-play"></i>
                        <span>Start Exam</span>
                    </button>
                    <button onclick="showExamDetails({{ token.exam.id }})" 
                            class="bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 transition duration-200">
                        <i class="fas fa-info"></i>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-12">
            <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-key text-gray-400 text-3xl"></i>
            </div>
            <h3 class="text-2xl font-semibold text-gray-600 mb-4">No Active Tokens Available</h3>
            <p class="text-gray-500 max-w-md mx-auto mb-6">
                There are no active exam tokens available at the moment. 
                Please check back later or contact your instructor for access tokens.
            </p>
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 max-w-md mx-auto">
                <div class="flex items-center text-blue-800">
                    <i class="fas fa-info-circle mr-3 text-xl"></i>
                    <div>
                        <p class="font-semibold">How to get access?</p>
                        <p class="text-sm">Contact your instructor or system administrator to generate exam tokens for you.</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Manual Token Input Section -->
    <div class="bg-white rounded-2xl shadow-lg p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
            <i class="fas fa-keyboard text-blue-500 mr-3"></i>
            Manual Token Entry
        </h2>
        
        <div class="max-w-md mx-auto">
            <div class="space-y-4">
                <div>
                    <label for="manualToken" class="block text-sm font-medium text-gray-700 mb-2">
                        Enter Exam Token
                    </label>
                    <input 
                        type="text" 
                        id="manualToken"
                        placeholder="Enter 6-character token"
                        class="token-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-center text-xl"
                        maxlength="6"
                        oninput="formatTokenInput(this)"
                    >
                    <p class="text-xs text-gray-500 mt-2 text-center">
                        Enter the 6-character token provided by your instructor
                    </p>
                </div>
                
                <button onclick="validateManualToken()" 
                        class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition duration-200 font-semibold flex items-center justify-center space-x-2">
                    <i class="fas fa-check-circle"></i>
                    <span>Validate & Start Exam</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Token Information Section -->
    <div class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-2xl shadow-lg p-6 text-white">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-2xl font-bold mb-2">About Exam Tokens</h2>
                <p class="text-blue-100">Secure access system for your examinations</p>
            </div>
            <div class="text-right">
                <div class="bg-white bg-opacity-20 rounded-lg p-4">
                    <p class="text-sm">System Status</p>
                    <p class="text-2xl font-bold">Secure</p>
                    <p class="text-xs">Token-based access</p>
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
            <div class="text-center">
                <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <h3 class="font-semibold mb-1">Secure Access</h3>
                <p class="text-blue-100 text-sm">Tokens provide secure, time-limited exam access</p>
            </div>
            <div class="text-center">
                <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-clock"></i>
                </div>
                <h3 class="font-semibold mb-1">Auto-Expiry</h3>
                <p class="text-blue-100 text-sm">Tokens automatically expire after designated time</p>
            </div>
            <div class="text-center">
                <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-sync"></i>
                </div>
                <h3 class="font-semibold mb-1">Auto-Refresh</h3>
                <p class="text-blue-100 text-sm">Page automatically updates when new tokens are available</p>
            </div>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl p-8 text-center">
        <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
        <p class="text-gray-700 font-semibold">Validating token...</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Format token input (6 characters, uppercase)
    function formatTokenInput(input) {
        let value = input.value.replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
        if (value.length > 6) value = value.substring(0, 6);
        input.value = value;
    }

    // Copy token to clipboard
    function copyToClipboard(token) {
        navigator.clipboard.writeText(token).then(() => {
            showNotification('Token copied to clipboard!', 'success');
        }).catch(() => {
            showNotification('Failed to copy token', 'error');
        });
    }

    // Start exam with token
    function startExamWithToken(token) {
        showLoading();
        validateToken(token);
    }

    // Validate manual token entry
    function validateManualToken() {
        const token = document.getElementById('manualToken').value.trim();
        
        if (token.length !== 6) {
            showNotification('Please enter a valid 6-character token', 'error');
            return;
        }
        
        showLoading();
        validateToken(token);
    }

    // Validate token via API
    function validateToken(token) {
        fetch('{% url "exam:validate_exam_token" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ token: token })
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.valid) {
                showNotification('Token validated! Redirecting to exam...', 'success');
                setTimeout(() => {
                    window.location.href = '{% url "exam:take_exam" 0 %}'.replace('0', data.exam_id);
                }, 1000);
            } else {
                showNotification('Error: ' + data.message, 'error');
            }
        })
        .catch(error => {
            hideLoading();
            showNotification('Validation failed. Please try again.', 'error');
        });
    }

    // Show exam details (placeholder)
    function showExamDetails(examId) {
        // Implement exam details modal or redirect
        window.location.href = '{% url "exam:exam_details" 0 %}'.replace('0', examId);
    }

    // Update countdown timers
    function updateCountdowns() {
        {% for token in active_tokens %}
        const countdownElement = document.getElementById('countdown-{{ token.id }}');
        const progressElement = document.getElementById('progress-{{ token.id }}');
        
        if (countdownElement && progressElement) {
            // This would need server-side calculation for accurate countdown
            // For now, we'll just update the display
            countdownElement.textContent = '{{ token.time_remaining }}';
        }
        {% endfor %}
    }

    // Update current time
    function updateCurrentTime() {
        const now = new Date();
        document.getElementById('current-time').textContent = 
            now.toLocaleDateString('en-US', { 
                month: 'long', 
                day: 'numeric', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
    }

    // Refresh token data
    function refreshTokenData() {
        fetch('{% url "exam:get_active_tokens" %}')
            .then(response => response.json())
            .then(data => {
                if (data.tokens.length !== {{ active_tokens.count }}) {
                    // If token count changed, reload the page
                    window.location.reload();
                }
            })
            .catch(error => console.error('Error refreshing tokens:', error));
    }

    // Show/hide loading spinner
    function showLoading() {
        document.getElementById('loadingSpinner').classList.remove('hidden');
    }

    function hideLoading() {
        document.getElementById('loadingSpinner').classList.add('hidden');
    }

    // Show notification
    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `fixed top-6 right-6 px-6 py-3 rounded-lg shadow-lg text-white font-semibold z-50 ${
            type === 'success' ? 'bg-green-500' : 'bg-red-500'
        }`;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    // Auto-refresh functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Update time every second
        setInterval(updateCurrentTime, 1000);
        
        // Update countdowns every 30 seconds
        setInterval(updateCountdowns, 30000);
        
        // Refresh token data every minute
        setInterval(refreshTokenData, 60000);
        
        // Auto-focus manual token input
        document.getElementById('manualToken')?.focus();
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + K to focus token input
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            document.getElementById('manualToken').focus();
        }
        
        // Enter to validate token when input is focused
        if (e.key === 'Enter' && document.activeElement.id === 'manualToken') {
            validateManualToken();
        }
    });

    console.log('Exam Access portal initialized');
</script>
{% endblock %}