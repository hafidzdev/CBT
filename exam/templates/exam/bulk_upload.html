<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk Upload Questions - CBT System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-green-600 text-white shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-upload text-2xl"></i>
                    <h1 class="text-xl font-bold">Bulk Upload Questions</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="{% url 'exam:teacher_questions' %}" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg transition duration-200">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Questions
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <div class="bg-white rounded-2xl shadow-lg p-8">
                <form method="post" enctype="multipart/form-data" id="uploadForm">
                    {% csrf_token %}
                    
                    <!-- Messages -->
                    {% if messages %}
                    <div class="mb-6">
                        {% for message in messages %}
                        <div class="{% if message.tags == 'error' %}bg-red-100 border-red-400 text-red-700{% else %}bg-green-100 border-green-400 text-green-700{% endif %} px-4 py-3 rounded mb-4">
                            {{ message }}
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <!-- File Upload Section -->
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Upload CSV File</h2>
                        
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-file-csv mr-2"></i>Select CSV File
                                </label>
                                <input type="file" name="file" id="csv_file" accept=".csv" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                       onchange="validateFile()">
                                <p class="text-sm text-gray-500 mt-1">
                                    Upload a CSV file with questions. 
                                    <a href="{% url 'exam:download_question_bank_template' %}" class="text-green-600 hover:text-green-700 font-medium">
                                        Download template
                                    </a>
                                </p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-book mr-2"></i>Select Exam
                                </label>
                                <select name="exam_id" id="exam_id" required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                        onchange="validateFile()">
                                    <option value="">-- Select Exam --</option>
                                    {% for exam in exams %}
                                        <option value="{{ exam.id }}">{{ exam.title }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Di dalam form, ganti bagian question bank -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-database mr-2"></i>Question Bank (Optional)
                                </label>
                                <select name="question_bank_id" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="">-- Select Question Bank (Optional) --</option>
                                    {% for bank in question_banks %}
                                        <option value="{{ bank.id }}">{{ bank.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- CSV Format Guide -->
                    <div class="mb-8 bg-yellow-50 border border-yellow-200 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-yellow-800 mb-4">
                            <i class="fas fa-info-circle mr-2"></i>CSV Format Guide
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-yellow-200">
                                <thead class="bg-yellow-100">
                                    <tr>
                                        <th class="px-4 py-2 border border-yellow-300">Question Text</th>
                                        <th class="px-4 py-2 border border-yellow-300">Question Type</th>
                                        <th class="px-4 py-2 border border-yellow-300">Points</th>
                                        <th class="px-4 py-2 border border-yellow-300">Difficulty</th>
                                        <th class="px-4 py-2 border border-yellow-300">Correct Answer</th>
                                        <th class="px-4 py-2 border border-yellow-300">Option A</th>
                                        <th class="px-4 py-2 border border-yellow-300">Option B</th>
                                        <th class="px-4 py-2 border border-yellow-300">Option C</th>
                                        <th class="px-4 py-2 border border-yellow-300">Option D</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="px-4 py-2 border border-yellow-300">What is 2+2?</td>
                                        <td class="px-4 py-2 border border-yellow-300">multiple_choice</td>
                                        <td class="px-4 py-2 border border-yellow-300">5</td>
                                        <td class="px-4 py-2 border border-yellow-300">easy</td>
                                        <td class="px-4 py-2 border border-yellow-300">A</td>
                                        <td class="px-4 py-2 border border-yellow-300">4</td>
                                        <td class="px-4 py-2 border border-yellow-300">5</td>
                                        <td class="px-4 py-2 border border-yellow-300">6</td>
                                        <td class="px-4 py-2 border border-yellow-300">7</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="flex justify-between items-center pt-6 border-t border-gray-200">
    <!-- Tombol Cancel -->
                        <a href="{% url 'exam:teacher_questions' %}" 
                        class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition duration-200 font-semibold">
                            <i class="fas fa-times mr-2"></i>Cancel
                        </a>

                        <!-- Form Upload CSV -->
                        <form method="POST" enctype="multipart/form-data" 
                            action="{% url 'exam:bulk_upload_questions' %}" 
                            class="flex items-center space-x-3">
                            {% csrf_token %}
                            <input type="file" id="csvFile" name="csv_file" accept=".csv"
                                class="border border-gray-300 rounded-lg p-2" required>

                            <button type="submit" id="uploadBtn"
                                class="bg-gray-400 text-white px-6 py-3 rounded-lg cursor-not-allowed transition duration-200 font-semibold flex items-center justify-center"
                                disabled>
                                <i class="fas fa-upload mr-2"></i>Upload Questions
                            </button>

                        </form>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        function validateFile() {
            const fileInput = document.getElementById('csv_file');
            const uploadBtn = document.getElementById('uploadBtn');
            const examSelect = document.getElementById('exam_id');
            
            // Cek apakah file dan exam sudah dipilih
            const hasFile = fileInput.files.length > 0;
            const hasExam = examSelect.value !== '';
            
            // Aktifkan tombol hanya jika kedua kondisi terpenuhi
            uploadBtn.disabled = !(hasFile && hasExam);
            
            // Update button text jika disabled
            if (uploadBtn.disabled) {
                uploadBtn.innerHTML = '<i class="fas fa-upload mr-2"></i>Upload Questions';
            }
        }

        // Handle form submission
        document.getElementById('uploadForm').addEventListener('submit', function(e) {
            const uploadBtn = document.getElementById('uploadBtn');
            const fileInput = document.getElementById('csv_file');
            const examSelect = document.getElementById('exam_id');
            
            // Validasi final sebelum submit
            if (!fileInput.files.length) {
                e.preventDefault();
                alert('Please select a CSV file to upload.');
                return;
            }
            
            if (!examSelect.value) {
                e.preventDefault();
                alert('Please select an exam.');
                return;
            }
            
            // Tampilkan loading state
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Uploading...';
            uploadBtn.disabled = true;
        });

        // Validasi saat page load
      
            document.addEventListener('DOMContentLoaded', function() {
                const fileInput = document.getElementById('csvFile');
                const uploadBtn = document.getElementById('uploadBtn');

                if (fileInput && uploadBtn) {
                    // Event saat file dipilih
                    fileInput.addEventListener('change', function() {
                        const hasFile = fileInput.files.length > 0;

                        // Aktifkan / nonaktifkan tombol
                        uploadBtn.disabled = !hasFile;

                        // Ubah warna tombol berdasarkan status
                        if (hasFile) {
                            uploadBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                            uploadBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                        } else {
                            uploadBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                            uploadBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                        }
                    });
                }
            });


    </script>
</body>
</html>