{% extends "admin/admin_base.html" %}
{% load static %}

{% block title %} User Details - {{ user.username }}{% endblock %}

{% block admin_body %}

<!-- BACK BUTTON -->
<div class="mb-4">
    <a href="{% url 'exam:admin_user_list' %}"
       class="inline-flex items-center px-4 py-2 bg-gray-200 hover:bg-primary-300 text-gray-700 text-sm font-semibold rounded-lg transition">
        <i class="fas fa-arrow-left mr-2"></i> Back to User Management
    </a>
</div>

<div class="max-w-5xl mx-auto p-6 space-y-8">

    <!-- Profile Summary Card -->
    <div class="bg-white rounded-2xl shadow p-8 text-center">

        {% if user.profile_picture %}
            <img src="{{ user.profile_picture.url }}" class="w-24 h-24 rounded-full mx-auto object-cover mb-4">
        {% else %}
            <div class="w-24 h-24 rounded-full bg-indigo-600 text-white flex items-center justify-center mx-auto mb-4 text-3xl font-bold">
                {{ user.username|first|upper }}
            </div>
        {% endif %}

        <h1 class="text-2xl font-bold text-gray-800">{{ user.get_full_name|default:user.username }}</h1>
        <p class="text-gray-500">@{{ user.username }}</p>

        <div class="mt-3">
            <span class="px-3 py-1 rounded-full text-sm font-semibold
                {% if user.user_type == 'student' %} bg-green-100 text-green-700
                {% elif user.user_type == 'teacher' %} bg-blue-100 text-blue-700
                {% elif user.user_type == 'admin' %} bg-red-100 text-red-700
                {% else %} bg-yellow-100 text-yellow-700 {% endif %}">
                {{ user.get_user_type_display }}
            </span>
        </div>

        <p class="mt-2 text-sm">
            {% if user.is_active %}
            <span class="text-green-600 font-semibold">Active</span>
            {% else %}
            <span class="text-red-600 font-semibold">Inactive</span>
            {% endif %}
        </p>
    </div>

    <!-- Tabs -->
    <div class="bg-white rounded-2xl shadow">
        <div class="border-b flex space-x-6 px-6 pt-4">
            <button class="tab-btn py-3 font-semibold text-indigo-600 border-b-2 border-indigo-600" data-tab="profile">
                Profile
            </button>

            {% if user.user_type == "student" %}
            <button class="tab-btn py-3 font-semibold text-gray-600 hover:text-indigo-600" data-tab="history">Exam History</button>
            <button class="tab-btn py-3 font-semibold text-gray-600 hover:text-indigo-600" data-tab="chart">Score Progress</button>
            {% endif %}
        </div>

        <div class="p-6 space-y-6">

            <!-- Profile TAB -->
            <div class="tab-section" id="tab-profile">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-gray-700">
                    <p><b>Full Name:</b> {{ user.get_full_name|default:user.username }}</p>
                    <p><b>Username:</b> {{ user.username }}</p>
                    <p><b>Email:</b> {{ user.email|default:"-" }}</p>
                    <p><b>Phone:</b> {{ user.phone_number|default:"-" }}</p>
                    <p><b>Gender:</b> {{ user.gender|title|default:"-" }}</p>
                    <p><b>Birth Date:</b> {{ user.birth_date|date:"M d, Y"|default:"-" }}</p>
                    <p><b>Address:</b> {{ user.address|default:"-" }}</p>
                    <p><b>Role:</b> {{ user.get_user_type_display }}</p>
                    <p><b>Status:</b>
                        {% if user.is_active %}
                            <span class="text-green-600 font-semibold">Active</span>
                        {% else %}
                            <span class="text-red-600 font-semibold">Inactive</span>
                        {% endif %}
                    </p>
                    <p><b>Registered:</b> {{ user.date_joined|date:"M d, Y" }}</p>
                    <p><b>Last Login:</b> {% if user.last_login %}{{ user.last_login|date:"M d, Y H:i" }}{% else %}Never{% endif %}</p>
                </div>
            </div>

            {% if user.user_type == "student" %}
            <!-- Exam History TAB -->
            <div class="tab-section hidden" id="tab-history">
                {% if exam_history %}
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse text-sm">
                        <thead>
                            <tr class="bg-gray-100 text-left">
                                <th class="p-3">Exam</th>
                                <th class="p-3">Score</th>
                                <th class="p-3">Status</th>
                                <th class="p-3">Completed</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for session in exam_history %}
                            <tr class="border-b hover:bg-gray-50">
                                <td class="p-3">{{ session.exam.title }}</td>
                                <td class="p-3 font-semibold {% if session.score >= session.exam.passing_score %}text-green-600{% else %}text-red-600{% endif %}">
                                    {{ session.score }}%
                                </td>
                                <td class="p-3">{{ session.get_status_display|default:"Completed" }}</td>
                                <td class="p-3">{{ session.end_time|date:"M d, Y H:i" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-gray-500 text-center py-6">Belum ada riwayat ujian.</p>
                {% endif %}
            </div>

            <!-- Score Chart TAB -->
            <div class="tab-section hidden" id="tab-chart">
                {% if chart_scores %}
                    <canvas id="scoreChart" height="120"></canvas>
                    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                    <script>
                    const ctx = document.getElementById('scoreChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: {{ chart_labels|safe }},
                            datasets: [{
                                label: 'Score',
                                data: {{ chart_scores|safe }},
                                borderColor: '#4f46e5',
                                backgroundColor: 'rgba(79,70,229,0.2)',
                                borderWidth: 2,
                                pointRadius: 4,
                                pointBackgroundColor: '#4f46e5'
                            }]
                        }
                    });
                    </script>
                {% else %}
                <p class="text-gray-500 text-center py-6">Belum ada nilai untuk ditampilkan.</p>
                {% endif %}
            </div>
            {% endif %}

        </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex gap-3">
        <a href="{% url 'exam:admin_user_edit' user.id %}" class="flex-1 bg-indigo-600 text-white text-center py-3 rounded-lg font-semibold hover:bg-indigo-700">Edit</a>

        {% if user.is_active %}
        <button onclick="confirmToggle('{{ user.id }}', 'deactivate')" class="flex-1 bg-yellow-500 text-white text-center py-3 rounded-lg font-semibold hover:bg-yellow-600">Deactivate</button>
        {% else %}
        <button onclick="confirmToggle('{{ user.id }}', 'activate')" class="flex-1 bg-green-600 text-white text-center py-3 rounded-lg font-semibold hover:bg-green-700">Activate</button>
        {% endif %}

        <button onclick="confirmDelete('{{ user.id }}')" class="flex-1 bg-red-600 text-white text-center py-3 rounded-lg font-semibold hover:bg-red-700">Delete</button>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
function confirmToggle(userId, actionType) {
    Swal.fire({
        title: actionType === 'deactivate' ? "Nonaktifkan user ini?" : "Aktifkan user ini?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: actionType === 'deactivate' ? "#d33" : "#10b981",
        cancelButtonColor: "#6b7280",
        confirmButtonText: actionType === 'deactivate' ? "Nonaktifkan" : "Aktifkan",
        cancelButtonText: "Batal"
    }).then((result) => {
        if (result.isConfirmed) {
            window.location.href = "{% url 'exam:admin_user_toggle' 9999 %}".replace("9999", userId);
        }
    });
}

function confirmDelete(userId) {
    Swal.fire({
        title: "Hapus user ini?",
        text: "Aksi ini tidak bisa dibatalkan.",
        icon: "error",
        showCancelButton: true,
        confirmButtonColor: "#d33",
        cancelButtonColor: "#6b7280",
        confirmButtonText: "Hapus",
        cancelButtonText: "Batal"
    }).then((result) => {
        if (result.isConfirmed) {
            window.location.href = "{% url 'exam:admin_user_delete' 9999 %}".replace("9999", userId);
        }
    });
}
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const tabs = document.querySelectorAll(".tab-btn");
    const sections = document.querySelectorAll(".tab-section");

    tabs.forEach(btn => {
        btn.addEventListener("click", () => {

            // reset tab style
            tabs.forEach(t => t.classList.remove("text-indigo-600","border-indigo-600","border-b-2"));
            tabs.forEach(t => t.classList.add("text-gray-600"));

            // aktifkan tab yang di klik
            btn.classList.remove("text-gray-600");
            btn.classList.add("text-indigo-600","border-indigo-600","border-b-2");

            // hide all tab content
            sections.forEach(sec => sec.classList.add("hidden"));

            // show target content
            const target = document.getElementById(`tab-${btn.dataset.tab}`);
            if(target) target.classList.remove("hidden");
        });
    });
});
</script>


{% endblock %}
